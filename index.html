<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KA Finance æ­£ç¢ºå°é½Šç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        .btn { background: #1a73e8; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #status { margin-top: 20px; color: #555; font-size: 14px; white-space: pre-wrap; text-align: left; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ“Š KA Finance å°ˆæ¥­è½‰æª”</h2>
        <input type="file" id="dbFile" accept=".db">
        <button class="btn" onclick="handleConvert()">åŸ·è¡Œè½‰æ› (å°é½Š Google Sheets)</button>
        <div id="status">æº–å‚™å°±ç·’ï¼Œè«‹é¸å–æ‚¨çš„ .db æª”æ¡ˆ</div>
    </div>

<script>
async function handleConvert() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }
    status.innerText = "â³ æ­£åœ¨è§£ææ‚¨çš„ KA Finance è³‡æ–™åº«...";

    try {
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const SQL = await initSqlJs({ locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${file}` });
            const db = new SQL.Database(new Uint8Array(fileReader.result));

            // ç²¾ç¢ºæŠ“å–æ‚¨çš„è³‡æ–™ï¼šæ—¥æœŸã€é …ç›®å…§å®¹(åƒè€ƒ)ã€é¡åˆ¥(äº¤æ˜“åˆ†é¡)ã€é‡‘é¡ã€å¸³æˆ¶
            [span_1](start_span)// æ ¹æ“šæ‚¨çš„æª”æ¡ˆçµæ§‹[span_1](end_span) å°é½Šæ¬„ä½
            const res = db.exec("SELECT æ—¥æœŸ, åƒè€ƒ, äº¤æ˜“åˆ†é¡, é‡‘é¡, å¸³æˆ¶ FROM records ORDER BY æ—¥æœŸ DESC");
            
            if (!res[0]) {
                // å¦‚æœ records ä¸å°ï¼Œå˜—è©¦æŠ“å–æ‰€æœ‰å¯èƒ½è¡¨æ ¼
                status.innerText = "âŒ æ‰¾ä¸åˆ° records è¡¨æ ¼ï¼Œè«‹æª¢æŸ¥ App åŒ¯å‡ºçš„æª”æ¡ˆã€‚";
                return;
            }

            const finalData = [["æ—¥æœŸ", "é …ç›®å…§å®¹", "åˆ†é¡", "é‡‘é¡", "å¸³æˆ¶"]];
            res[0].values.forEach(row => {
                finalData.push([
                    row[0].split(' ')[0], // åªå–æ—¥æœŸéƒ¨åˆ† YYYY-MM-DD
                    row[1] || "ç„¡å‚™è¨»",    // é …ç›®å…§å®¹
                    row[2] || "æœªåˆ†é¡",    // é¡åˆ¥
                    row[3],               // é‡‘é¡
                    row[4]                // å¸³æˆ¶
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(finalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è½‰æ›çµæœ");

            XLSX.writeFile(wb, "KA_Finance_Fixed.xlsx");
            status.innerText = `âœ… æˆåŠŸï¼å·²è™•ç† ${res[0].values.length} ç­†è³‡æ–™ã€‚`;
        };
        fileReader.readAsArrayBuffer(fileInput.files[0]);
    } catch (e) {
        status.innerText = "âŒ éŒ¯èª¤åŸå› ï¼š" + e.message;
    }
}
</script>
</body>
</html>
