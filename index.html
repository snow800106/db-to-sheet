<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KA Finance è‡ªå‹•ä¿®å¾©è½‰æª”</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        .btn { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #status { margin-top: 15px; color: #d93025; font-size: 14px; white-space: pre-wrap; text-align: left; background: #fff5f5; padding: 10px; border-radius: 5px; display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸš€ KA Finance è‡ªå‹•åµæ¸¬è½‰æª”</h2>
        <p style="color:#666; font-size:13px;">è‡ªå‹•é©æ‡‰æ–°èˆŠæª”æ¡ˆæ ¼å¼</p>
        <input type="file" id="dbFile" accept=".db">
        <button class="btn" onclick="autoDetectConvert()">ä¸€éµåµæ¸¬ä¸¦ä¸‹è¼‰</button>
        <div id="status"></div>
    </div>

<script>
async function autoDetectConvert() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }
    
    status.style.display = "block";
    status.style.color = "#555";
    status.innerText = "â³ æ­£åœ¨æƒæè³‡æ–™åº«çµæ§‹...";

    try {
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const SQL = await initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${f}` });
            const db = new SQL.Database(new Uint8Array(fileReader.result));

            // 1. å–å¾—æ‰€æœ‰è¡¨æ ¼
            const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
            if (!tables[0]) throw new Error("è³‡æ–™åº«å…§æ²’æœ‰ä»»ä½•è¡¨æ ¼");
            const allTableNames = tables[0].values.map(v => v[0]);

            // 2. è‡ªå‹•å°‹æ‰¾æœ€åƒã€Œæµæ°´å¸³ã€çš„è¡¨æ ¼
            let targetTable = "";
            let sqlQuery = "";

            // ç­–ç•¥ A: æ‰¾å°‹åŒ…å«ä¸­æ–‡æ¬„ä½ã€Œæ—¥æœŸã€æˆ–ã€Œäº¤æ˜“åˆ†é¡ã€çš„è¡¨
            for (let name of allTableNames) {
                const columns = db.exec(`PRAGMA table_info(${name})`)[0].values.map(v => v[1]);
                if (columns.includes("æ—¥æœŸ") && columns.includes("é‡‘é¡")) {
                    targetTable = name;
                    // æ ¹æ“šæ‚¨ Google Sheets è¦æ±‚çš„é †åºæŠ“å–
                    sqlQuery = `SELECT æ—¥æœŸ, åƒè€ƒ, äº¤æ˜“åˆ†é¡, é‡‘é¡, å¸³æˆ¶ FROM ${name} ORDER BY æ—¥æœŸ DESC`;
                    break;
                }
                // ç­–ç•¥ B: å‚™ç”¨æ–¹æ¡ˆ (é‡å°è‹±æ–‡ç‰ˆçµæ§‹)
                if (columns.includes("date") && columns.includes("amount")) {
                    targetTable = name;
                    sqlQuery = `SELECT date, description, category, amount, account FROM ${name} ORDER BY date DESC`;
                    break;
                }
            }

            if (!targetTable) throw new Error("åµæ¸¬ä¸åˆ°è¨˜å¸³è¡¨æ ¼ï¼Œæ‰¾åˆ°çš„è¡¨æ ¼æœ‰: " + allTableNames.join(", "));

            const res = db.exec(sqlQuery);
            if (!res[0]) throw new Error(`è¡¨æ ¼ ${targetTable} å…§æ²’æœ‰è³‡æ–™`);

            const finalData = [["æ—¥æœŸ", "é …ç›®å…§å®¹", "åˆ†é¡", "é‡‘é¡", "å¸³æˆ¶"]];
            res[0].values.forEach(row => {
                finalData.push([
                    row[0].split(' ')[0], // æ—¥æœŸ YYYY-MM-DD
                    row[1] || "",         // é …ç›®
                    row[2] || "",         // åˆ†é¡
                    row[3] || 0,          // é‡‘é¡
                    row[4] || ""          // å¸³æˆ¶
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(finalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Synced");
            XLSX.writeFile(wb, "KA_Finance_AutoFixed.xlsx");
            
            status.style.color = "#28a745";
            status.innerText = `âœ… åµæ¸¬æˆåŠŸï¼å¾è¡¨æ ¼ã€Œ${targetTable}ã€æŠ“å– ${res[0].values.length} ç­†è³‡æ–™ã€‚`;
        };
        fileReader.readAsArrayBuffer(fileInput.files[0]);
    } catch (e) {
        status.style.color = "#d93025";
        status.innerText = "âŒ åµæ¸¬å¤±æ•—ï¼š" + e.message;
    }
}
</script>
</body>
</html>
