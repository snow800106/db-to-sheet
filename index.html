<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KA Finance æœ€çµ‚è½‰æª”å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        h2 { color: #1a73e8; margin-bottom: 20px; }
        .btn { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn:active { background: #174ea6; transform: scale(0.98); }
        #status { margin-top: 15px; color: #555; font-size: 14px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ“Š KA Finance å°ˆæ¥­è½‰æª”</h2>
        <p style="color:#666; font-size:13px;">å°é½Šæ ¼å¼ï¼šæ—¥æœŸã€é …ç›®å…§å®¹ã€åˆ†é¡ã€é‡‘é¡ã€å¸³æˆ¶</p>
        <input type="file" id="dbFile" accept=".db">
        <button class="btn" onclick="processDB()">åŸ·è¡Œè½‰æ›ä¸¦ä¸‹è¼‰</button>
        <div id="status">è«‹é¸å–æ‚¨æœ€æ–°ä¸Šå‚³çš„ .db æª”æ¡ˆ</div>
    </div>

<script>
async function processDB() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }
    
    status.innerText = "â³ æ­£åœ¨åˆ†æè³‡æ–™çµæ§‹ä¸¦æå–æ•¸æ“š...";

    try {
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            try {
                // åˆå§‹åŒ–è§£æå¼•æ“
                const SQL = await initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${f}` });
                const db = new SQL.Database(new Uint8Array(fileReader.result));

                // æ ¹æ“šæ‚¨çš„æª”æ¡ˆçµæ§‹ï¼Œç²¾ç¢ºæŠ“å–é€™äº”å€‹æ¬„ä½
                // åƒè€ƒ = é …ç›®å…§å®¹, äº¤æ˜“åˆ†é¡ = åˆ†é¡
                const res = db.exec("SELECT æ—¥æœŸ, åƒè€ƒ, äº¤æ˜“åˆ†é¡, é‡‘é¡, å¸³æˆ¶ FROM records ORDER BY æ—¥æœŸ DESC");
                
                if (!res[0]) throw new Error("æ‰¾ä¸åˆ°è¨˜å¸³è³‡æ–™è¡¨æ ¼ records");

                const finalData = [["æ—¥æœŸ", "é …ç›®å…§å®¹", "åˆ†é¡", "é‡‘é¡", "å¸³æˆ¶"]];
                res[0].values.forEach(row => {
                    finalData.push([
                        row[0].split(' ')[0], // æ ¼å¼åŒ–æ—¥æœŸç‚º YYYY-MM-DD
                        row[1] || "ç„¡å‚™è¨»",    // é …ç›®å…§å®¹
                        row[2] || "æœªåˆ†é¡",    // åˆ†é¡
                        row[3],               // é‡‘é¡
                        row[4]                // å¸³æˆ¶
                    ]);
                });

                // åŒ¯å‡º Excel
                const ws = XLSX.utils.aoa_to_sheet(finalData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Synced_Result");
                XLSX.writeFile(wb, "KA_Finance_Final_Export.xlsx");
                
                status.innerText = `âœ… æˆåŠŸï¼å·²è½‰æ› ${res[0].values.length} ç­†è³‡æ–™ã€‚\næ ¼å¼å·²å®Œå…¨å°é½Šç¯„ä¾‹ã€‚`;
            } catch (innerErr) {
                status.innerText = "âŒ è§£æå¤±æ•—ï¼š" + innerErr.message;
            }
        };
        fileReader.readAsArrayBuffer(fileInput.files[0]);
    } catch (e) {
        status.innerText = "âŒ ç³»çµ±éŒ¯èª¤ï¼š" + e.message;
    }
}
</script>
</body>
</html>
