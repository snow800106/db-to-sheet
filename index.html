<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAFinance è½‰æª”å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        h1 { font-size: 24px; color: #1a73e8; margin-bottom: 20px; }
        input[type="file"] { margin: 20px 0; width: 100%; border: 1px dashed #4285f4; padding: 10px; border-radius: 10px; }
        button { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        button:disabled { background: #ccc; }
        #status { margin-top: 20px; font-size: 14px; color: #555; line-height: 1.5; word-break: break-all; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ“Š è¨˜å¸³è½‰æª”å·¥å…·</h1>
        <input type="file" id="dbFile" accept=".db">
        <button id="btn" onclick="handleConvert()">åŸ·è¡Œè½‰æ›ä¸¦ä¸‹è¼‰ Excel</button>
        <div id="status">æº–å‚™å°±ç·’ï¼Œè«‹é¸å– .db æª”æ¡ˆ</div>
    </div>

<script>
async function handleConvert() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    const btn = document.getElementById('btn');
    
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }
    
    btn.disabled = true;
    status.innerHTML = "â³ æ­£åœ¨å•Ÿå‹•å¼•æ“...<br>(åˆæ¬¡ä½¿ç”¨è«‹ç­‰å¾…ç´„ 5-10 ç§’)";

    try {
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            try {
                // åˆå§‹åŒ– SQL å¼•æ“
                const config = { locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${file}` };
                const SQL = await initSqlJs(config);
                const db = new SQL.Database(new Uint8Array(fileReader.result));
                
                status.innerText = "ğŸ” æ­£åœ¨æœå°‹æµæ°´å¸³è¡¨æ ¼...";
                
                // 1. å–å¾—æ‰€æœ‰è¡¨æ ¼
                const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
                if (!tables[0]) throw new Error("æ­¤æª”æ¡ˆä¸åŒ…å«ä»»ä½•è³‡æ–™è¡¨ã€‚");
                
                const tableNames = tables[0].values.map(v => v[0]);
                // 2. é‡å°ã€Œå¡å¡è¨˜å¸³ã€æˆ–é¡ä¼¼ App çš„å¸¸ç”¨è¡¨æ ¼åç¨±é€²è¡Œæœå°‹
                const target = tableNames.find(t => ['record', 'account', 'detail', 'money'].some(k => t.toLowerCase().includes(k))) || tableNames[0];
                
                status.innerText = `ğŸ“‚ æ­£åœ¨å¾ã€Œ${target}ã€æå–è³‡æ–™...`;
                
                // 3. æå–æ‰€æœ‰æ¬„ä½
                const res = db.exec(`SELECT * FROM ${target}`);
                if (!res[0]) throw new Error("é¸å®šçš„è¡¨æ ¼å…§æ²’æœ‰è³‡æ–™ã€‚");

                // 4. è½‰æ›ç‚º Excel
                const finalData = [res[0].columns, ...res[0].values];
                const ws = XLSX.utils.aoa_to_sheet(finalData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Export_Result");

                XLSX.writeFile(wb, "KAFinance_Fixed_Export.xlsx");
                status.innerHTML = "âœ… <b>è½‰æ›æˆåŠŸï¼</b><br>æª”æ¡ˆå·²å­˜è‡³æ‚¨çš„ä¸‹è¼‰è³‡æ–™å¤¾ã€‚";
            } catch (err) {
                status.innerHTML = "âŒ <b>å¤±æ•—ï¼š</b>" + err.message;
            } finally {
                btn.disabled = false;
            }
        };
        fileReader.readAsArrayBuffer(fileInput.files[0]);
    } catch (e) {
        status.innerText = "âŒ ç³»çµ±éŒ¯èª¤ï¼š" + e.message;
        btn.disabled = false;
    }
}
</script>
</body>
</html>
