<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KA Finance æ¥µé€Ÿè½‰æª”</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f7f9; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        .btn { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #status { margin-top: 15px; color: #555; font-size: 14px; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸš€ KA Finance æ¥µé€Ÿè½‰æª”</h2>
        <input type="file" id="dbFile" accept=".db">
        <button class="btn" onclick="fastConvert()">ç«‹å³è½‰æª” (å°é½Šç¯„ä¾‹æ ¼å¼)</button>
        <div id="status">è«‹é¸å–æª”æ¡ˆï¼Œ1ç§’å®Œæˆè½‰æ›</div>
    </div>

<script>
async function fastConvert() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    if (!fileInput.files[0]) return;
    
    status.innerText = "âš¡ è™•ç†ä¸­...";
    const reader = new FileReader();
    reader.onload = async function() {
        try {
            const SQL = await initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${f}` });
            const db = new SQL.Database(new Uint8Array(reader.result));

            // ç²¾ç¢ºæŠ“å–æµæ°´å¸³ï¼šæ—¥æœŸã€åƒè€ƒ(é …ç›®)ã€äº¤æ˜“åˆ†é¡(é¡åˆ¥)ã€é‡‘é¡ã€å¸³æˆ¶
            const res = db.exec("SELECT æ—¥æœŸ, åƒè€ƒ, äº¤æ˜“åˆ†é¡, é‡‘é¡, å¸³æˆ¶ FROM records ORDER BY æ—¥æœŸ DESC");
            
            if (!res[0]) throw new Error("æ‰¾ä¸åˆ°æ­£ç¢ºçš„è¨˜å¸³è¡¨æ ¼");

            // å»ºç«‹å®Œå…¨ç¬¦åˆ Google Sheets ç¯„ä¾‹çš„æ ¼å¼
            const finalData = [["æ—¥æœŸ", "é …ç›®å…§å®¹", "åˆ†é¡", "é‡‘é¡", "å¸³æˆ¶"]];
            res[0].values.forEach(row => {
                finalData.push([
                    row[0].split(' ')[0], // æ ¼å¼åŒ–æ—¥æœŸï¼šYYYY-MM-DD
                    row[1] || "ç„¡å…§å®¹", 
                    row[2] || "æœªåˆ†é¡", 
                    row[3] || 0, 
                    row[4] || "é è¨­å¸³æˆ¶"
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(finalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Synced");
            XLSX.writeFile(wb, "KA_Finance_Synced.xlsx");
            
            status.innerText = "âœ… è½‰æ›å®Œæˆï¼å…± " + res[0].values.length + " ç­†è³‡æ–™ã€‚";
        } catch (e) {
            status.innerText = "âŒ éŒ¯èª¤ï¼š" + e.message;
        }
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
}
</script>
</body>
</html>
