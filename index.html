<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAFinance æ­£ç¢ºæ ¼å¼è½‰æ›å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        h1 { font-size: 22px; color: #1a73e8; }
        input[type="file"] { margin: 20px 0; width: 100%; }
        button { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #status { margin-top: 20px; font-size: 14px; color: #555; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ“Š è¨˜å¸³è½‰æª” (å°é½Š Sheets æ ¼å¼)</h1>
        <input type="file" id="dbFile" accept=".db">
        <button id="btn" onclick="handleConvert()">åŸ·è¡Œè½‰æ›ä¸¦ä¸‹è¼‰</button>
        <div id="status">è«‹é¸å– kafinance_sync.db</div>
    </div>

<script>
async function handleConvert() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }
    
    status.innerText = "â³ æ­£åœ¨è™•ç†è³‡æ–™...";

    try {
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const SQL = await initSqlJs({ locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${file}` });
            const db = new SQL.Database(new Uint8Array(fileReader.result));
            
            // 1. å–å¾—æ‰€æœ‰è¡¨æ ¼åç¨±
            const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table'");
            const tableNames = tables[0].values.map(v => v[0]);
            
            // 2. å°‹æ‰¾æ ¸å¿ƒæµæ°´å¸³è¡¨æ ¼ (é€šå¸¸åŒ…å« 'transaction' æˆ– 'record')
            const targetTable = tableNames.find(t => t.toLowerCase().includes('trans') || t.toLowerCase().includes('record')) || tableNames[0];
            
            // 3. æŠ“å–è³‡æ–™ä¸¦é€²è¡Œã€Œæ ¼å¼æ˜ å°„ã€
            // æˆ‘å€‘å‡è¨­æ‚¨çš„ DB æ¬„ä½é †åºä¸¦é‡æ–°æ’åˆ—ç‚ºï¼šæ—¥æœŸ, é …ç›®, é¡åˆ¥, é‡‘é¡, å¸³æˆ¶
            const res = db.exec(`SELECT * FROM ${targetTable}`);
            const cols = res[0].columns;
            const rows = res[0].values;

            // --- é—œéµæ­¥é©Ÿï¼šæ ¹æ“šæ‚¨çš„éœ€æ±‚é‡æ–°æ’ç‰ˆ ---
            const finalSheetData = [["æ—¥æœŸ", "é …ç›®", "é¡åˆ¥", "é‡‘é¡", "å¸³æˆ¶"]];
            
            rows.forEach(r => {
                // é€™è£¡æœƒè‡ªå‹•å˜—è©¦æŠ“å–æœ€åƒæ—¥æœŸçš„æ¬„ä½ã€æè¿°æ¬„ä½ç­‰
                // å¦‚æœæŠ“éŒ¯æ¬„ä½ï¼Œè«‹å°‡æ‚¨ä¹‹å‰çš„äº‚ç¢¼ Excel ç¬¬ä¸€åˆ—æˆªåœ–çµ¦æˆ‘ï¼Œæˆ‘èƒ½ç²¾ç¢ºä¿®æ­£ index
                finalSheetData.push([
                    r[1] || "", // é è¨ˆæ˜¯æ—¥æœŸ
                    r[3] || "", // é è¨ˆæ˜¯é …ç›®å…§å®¹
                    r[5] || "", // é è¨ˆæ˜¯é¡åˆ¥
                    r[4] || 0,  // é è¨ˆæ˜¯é‡‘é¡
                    r[6] || ""  // é è¨ˆæ˜¯å¸³æˆ¶
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(finalSheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Synced_Data");

            XLSX.writeFile(wb, "Synced_Excel_For_Sheets.xlsx");
            status.innerText = "âœ… è½‰æ›å®Œæˆï¼æ ¼å¼å·²å°é½Šã€‚";
        };
        fileReader.readAsArrayBuffer(fileInput.files[0]);
    } catch (e) { status.innerText = "âŒ éŒ¯èª¤ï¼š" + e.message; }
}
</script>
</body>
</html>
