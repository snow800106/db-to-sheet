<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAFinance è½‰æª”å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; background: #f7f7f7; text-align: center; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: auto; }
        input, button { width: 100%; margin-top: 15px; padding: 12px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: #1a73e8; color: white; border: none; font-weight: bold; cursor: pointer; }
        #status { margin-top: 15px; font-size: 14px; color: #666; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ğŸ“Š è¨˜å¸³è½‰æª”å·¥å…·</h1>
        <input type="file" id="dbFile" accept=".db">
        <button onclick="handleConvert()">åŸ·è¡Œè½‰æ›ä¸¦ä¸‹è¼‰ Excel</button>
        <div id="status">è«‹é¸å– kafinance_sync.db</div>
    </div>

<script>
async function handleConvert() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }
    status.innerText = "â³ æ­£åœ¨è§£æè³‡æ–™åº«...";

    try {
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
            const db = new SQL.Database(new Uint8Array(fileReader.result));
            
            // è‡ªå‹•æœå°‹åŒ…å«è¨˜å¸³è³‡æ–™çš„è¡¨æ ¼
            const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
            if (!tables[0]) throw new Error("è³‡æ–™åº«å…§æ²’æœ‰è¡¨æ ¼");
            
            // å„ªå…ˆæ‰¾å°‹æœ‰ 'record' æˆ– 'money' å­—çœ¼çš„è¡¨æ ¼ï¼Œå¦å‰‡æŠ“ç¬¬ä¸€å€‹
            const allTables = tables[0].values.map(v => v[0]);
            const targetTable = allTables.find(t => t.toLowerCase().includes('record') || t.toLowerCase().includes('money')) || allTables[0];
            
            const res = db.exec(`SELECT * FROM ${targetTable}`);
            if (!res[0]) throw new Error("è¡¨æ ¼å…§ç„¡è³‡æ–™");

            const finalData = [res[0].columns, ...res[0].values];
            const ws = XLSX.utils.aoa_to_sheet(finalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Result");

            XLSX.writeFile(wb, "KAFinance_Export.xlsx");
            status.innerText = "âœ… è½‰æ›æˆåŠŸï¼å·²ä¸‹è¼‰ã€‚";
        };
        fileReader.readAsArrayBuffer(fileInput.files[0]);
    } catch (e) { status.innerText = "âŒ éŒ¯èª¤ï¼š" + e.message; }
}
</script>
</body>
</html>
