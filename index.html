<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KA Finance æ¥µé€Ÿè½‰æª”</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        h2 { color: #1a73e8; margin-bottom: 25px; font-size: 22px; }
        .file-input { margin-bottom: 20px; width: 100%; }
        .btn { background: #1a73e8; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; font-size: 14px; color: #666; line-height: 1.6; }
        .loader { display: none; margin: 10px auto; border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸš€ KA æ¥µé€Ÿè½‰æª”</h2>
        <input type="file" id="dbFile" class="file-input" accept=".db">
        <button id="mainBtn" class="btn" onclick="startConvert()">ç«‹å³è½‰æ›ä¸‹è¼‰</button>
        <div id="loader" class="loader"></div>
        <div id="status">æº–å‚™å°±ç·’</div>
    </div>

<script>
async function startConvert() {
    const fileInput = document.getElementById('dbFile');
    const status = document.getElementById('status');
    const btn = document.getElementById('mainBtn');
    const loader = document.getElementById('loader');

    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }

    btn.disabled = true;
    loader.style.display = "block";
    status.innerText = "âš¡ æ­£åœ¨å•Ÿå‹•å¼•æ“...";

    const reader = new FileReader();
    reader.onload = async function() {
        try {
            status.innerText = "ğŸ“‚ æ­£åœ¨è®€å–è³‡æ–™åº«...";
            const SQL = await initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${f}` });
            const db = new SQL.Database(new Uint8Array(reader.result));

            // è‡ªå‹•åµæ¸¬è¡¨æ ¼ (ä¸å†å¯«æ­» records)
            const tables = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
            const allTableNames = tables[0].values.map(v => v[0]);
            
            // å„ªå…ˆæ‰¾å°‹åŒ…å«è¨˜å¸³è³‡è¨Šçš„è¡¨æ ¼
            let targetTable = allTableNames.find(t => t.includes('record') || t.includes('detail') || t.includes('trans')) || allTableNames[0];
            
            status.innerText = `ğŸ“Š æ­£åœ¨è™•ç† ${targetTable} ...`;
            
            // æŠ“å–å…¨éƒ¨æ¬„ä½ä¸¦éæ¿¾
            const res = db.exec(`SELECT * FROM ${targetTable} ORDER BY 1 DESC`);
            
            if (!res[0]) throw new Error("è¡¨æ ¼å…§æ²’æœ‰è³‡æ–™");

            // ä¸‹è¼‰ Excel
            const ws = XLSX.utils.aoa_to_sheet([res[0].columns, ...res[0].values]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            
            XLSX.writeFile(wb, "KA_Quick_Export.xlsx");
            
            status.style.color = "#28a745";
            status.innerText = "âœ… è½‰æª”å®Œæˆï¼å·²è‡ªå‹•ä¸‹è¼‰ã€‚";
        } catch (e) {
            status.style.color = "#d93025";
            status.innerText = "âŒ éŒ¯èª¤ï¼š" + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
            loader.style.display = "none";
        }
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
}
</script>
</body>
</html>
