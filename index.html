<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KA Finance è¡¨æ ¼åµæ¸¬å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 450px; margin: auto; }
        button { background: #1a73e8; color: white; border: none; padding: 15px; width: 100%; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        #log { margin-top: 20px; text-align: left; font-size: 13px; color: #d93025; background: #fff5f5; padding: 10px; border-radius: 5px; display: none; white-space: pre-wrap; }
        #success-info { margin-top: 20px; color: #28a745; font-weight: bold; display: none; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ğŸ” è¡¨æ ¼åµæ¸¬èˆ‡è½‰æ›</h2>
        <input type="file" id="dbFile" accept=".db">
        <button onclick="detectAndConvert()">åµæ¸¬ä¸¦è½‰æª”</button>
        <div id="success-info">âœ… è½‰æ›æˆåŠŸï¼å·²ä¸‹è¼‰ã€‚</div>
        <div id="log"></div>
    </div>

<script>
async function detectAndConvert() {
    const fileInput = document.getElementById('dbFile');
    const log = document.getElementById('log');
    const success = document.getElementById('success-info');
    
    if (!fileInput.files[0]) { alert("è«‹å…ˆé¸å–æª”æ¡ˆ"); return; }
    
    log.style.display = "block";
    log.innerText = "â³ æ­£åœ¨åˆ†æè³‡æ–™åº«çµæ§‹...";
    success.style.display = "none";

    try {
        const fileReader = new FileReader();
        fileReader.onload = async function() {
            const SQL = await initSqlJs({ locateFile: f => `https://cdn.jsdelivr.net/npm/sql.js@1.6.2/dist/${f}` });
            const db = new SQL.Database(new Uint8Array(fileReader.result));

            // 1. å–å¾—æ‰€æœ‰è¡¨æ ¼æ¸…å–®
            const tableList = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
            
            if (!tableList[0]) {
                log.innerText = "âŒ éŒ¯èª¤ï¼šé€™æ˜¯ä¸€å€‹ç©ºçš„è³‡æ–™åº«ï¼Œæ‰¾ä¸åˆ°ä»»ä½•è¡¨æ ¼ã€‚";
                return;
            }

            const names = tableList[0].values.map(v => v[0]);
            log.innerText = "æ‰¾åˆ°ä»¥ä¸‹è¡¨æ ¼ï¼š\n" + names.join("\n") + "\n\næ­£åœ¨å°‹æ‰¾è¨˜å¸³è³‡æ–™...";

            // 2. å°‹æ‰¾åŒ…å«æœ€å¤šæ¬„ä½çš„è¡¨æ ¼ï¼ˆé€šå¸¸å°±æ˜¯æµæ°´å¸³è¡¨ï¼‰
            let bestTable = "";
            let maxCols = 0;
            
            for (let name of names) {
                const info = db.exec(`PRAGMA table_info(${name})`);
                if (info[0] && info[0].values.length > maxCols) {
                    maxCols = info[0].values.length;
                    bestTable = name;
                }
            }

            log.innerText += `\nåˆ¤å®šä¸»è¡¨æ ¼ç‚ºï¼š${bestTable}\næ­£åœ¨å°é½Šæ ¼å¼...`;

            // 3. æŠ“å–è³‡æ–™
            const content = db.exec(`SELECT * FROM ${bestTable} LIMIT 5000`);
            if (!content[0]) {
                log.innerText += `\nâŒ éŒ¯èª¤ï¼šè¡¨æ ¼ ${bestTable} æ˜¯ç©ºçš„ã€‚`;
                return;
            }

            // 4. ä¸‹è¼‰åŸå§‹è³‡æ–™ä¾›æª¢æŸ¥
            const ws = XLSX.utils.aoa_to_sheet([content[0].columns, ...content[0].values]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "RawData");
            XLSX.writeFile(wb, "KA_Finance_Check.xlsx");

            log.style.display = "none";
            success.style.display = "block";
            alert("å·²æˆåŠŸåŒ¯å‡ºåŸå§‹è³‡æ–™ï¼è«‹æª¢æŸ¥ Excel å…§å®¹ã€‚");
        };
        fileReader.readAsArrayBuffer(fileInput.files[0]);
    } catch (e) {
        log.innerText = "âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message;
    }
}
</script>
</body>
</html>
